name: Rejourney CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  API_IMAGE: ghcr.io/${{ github.repository }}/api
  WEB_IMAGE: ghcr.io/${{ github.repository }}/web
  MIGRATION_IMAGE: ghcr.io/${{ github.repository }}/migration

jobs:
  # ------------------------------------------------------------------
  # VERSION CHECK (Root)
  # ------------------------------------------------------------------
  check-version:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      changed: ${{ steps.version-check.outputs.changed }}
    steps:
      - uses: actions/checkout@v4

      - name: Install SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Compare with VPS Version
        id: version-check
        run: |
           LOCAL_VERSION=$(jq -r .version package.json)
           
           echo "Fetching version from VPS..."
           REMOTE_VERSION="0.0.0"
           
           # Check if remote file exists before trying to cat it
           if ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.VPS_HOST }} "test -f /opt/rejourney/package.json"; then
             ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.VPS_HOST }} "cat /opt/rejourney/package.json" > remote_package.json
             if [ -s remote_package.json ]; then
               REMOTE_VERSION=$(jq -r .version remote_package.json)
             fi
           else
             echo "âš ï¸ File /opt/rejourney/package.json not found on VPS. Assuming first deployment."
           fi

           echo "Local Version: $LOCAL_VERSION"
           echo "Remote Version: $REMOTE_VERSION"

           if [ "$LOCAL_VERSION" != "$REMOTE_VERSION" ]; then
             echo "changed=true" >> $GITHUB_OUTPUT
             echo "âœ… Version changed. Deploy required."
           else
             echo "changed=false" >> $GITHUB_OUTPUT
             echo "zzz Version unchanged. Skipping."
           fi

  # ------------------------------------------------------------------
  # BACKEND JOBS
  # ------------------------------------------------------------------
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24' 
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci --ignore-scripts

      - name: Lint
        working-directory: ./backend
        run: npm run lint --if-present

      - name: Unit Tests
        working-directory: ./backend
        run: npm test

      - name: Billing Tests
        working-directory: ./backend
        run: npm test -- --testNamePattern="billing|Billing|renewal|Renewal|downgrade|Downgrade" --reporter=verbose

      - name: Lint Billing Code
        working-directory: ./backend
        run: npx eslint src/services/stripe.ts src/services/stripeProducts.ts src/utils/billing.ts --max-warnings=0

  # ------------------------------------------------------------------
  # WEB JOBS
  # ------------------------------------------------------------------
  web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Debug file structure
        working-directory: ./dashboard/web-ui
        run: |
          ls -R app/lib
          cat app/lib/cn.ts || echo "cn.ts not found"

      - name: TypeScript check
        working-directory: ./dashboard/web-ui
        run: npm run typecheck

      - name: Build Web (SSR)
        working-directory: ./dashboard/web-ui
        run: npm run build


  # ------------------------------------------------------------------
  # DOCKER BUILD
  # ------------------------------------------------------------------
  build-images:
    needs: [backend, web]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install dependencies and download GeoIP data
        run: |
          npm ci
          # Verify geoip data was downloaded
          ls -la node_modules/geoip-lite/data/
      
      - name: Build API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.API_IMAGE }}:latest
            ${{ env.API_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Web
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dashboard/web-ui/Dockerfile
          push: true
          tags: |
            ${{ env.WEB_IMAGE }}:latest
            ${{ env.WEB_IMAGE }}:${{ github.sha }}
          build-args: |
             VITE_STRIPE_PUBLISHABLE_KEY=${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
             VITE_DASHBOARD_URL=https://rejourney.co/dashboard
             VITE_API_URL=https://api.rejourney.co
             VITE_DOCS_URL=https://rejourney.co/docs
             VITE_TURNSTILE_SITE_KEY=${{ secrets.TURNSTILE_SITE_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Migration
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile.migration
          push: true
          tags: |
            ${{ env.MIGRATION_IMAGE }}:latest
            ${{ env.MIGRATION_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ------------------------------------------------------------------
  # DEPLOY TO VPS
  # ------------------------------------------------------------------
  deploy:
    needs: [build-images, check-version]
    if: success() && github.ref == 'refs/heads/main' && (needs.check-version.outputs.changed == 'true' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
       - name: Deploy to VPS
         uses: appleboy/ssh-action@v1.0.3
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
           IMAGE_TAG: ${{ github.sha }}
         with:
           host: ${{ secrets.VPS_HOST }}
           username: root
           key: ${{ secrets.VPS_SSH_KEY }}
           timeout: 60m
           command_timeout: 60m
           envs: GITHUB_TOKEN,IMAGE_TAG
           script: |
             # Update Repo
             # Ensure the directory exists
             if [ ! -d "/opt/rejourney" ]; then
               echo "Directory /opt/rejourney not found, cloning..."
               git clone https://${GITHUB_TOKEN}@github.com/${{ github.repository }}.git /opt/rejourney
             fi
             
             # SAFE CD: Exit if cd fails
             cd /opt/rejourney || exit 1
             
             # Use token for origin to allow fetching
             git remote set-url origin https://${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

             # If it's not a git repo, initialize it (fallback)
             if [ ! -d ".git" ]; then
               echo "Not a git repository, fixing..."
               # CAREFUL: Only delete if we are CONFIRMED in /opt/rejourney
               if [ "$(pwd)" == "/opt/rejourney" ]; then
                   rm -rf * .[^.]*
                   git clone https://${GITHUB_TOKEN}@github.com/${{ github.repository }}.git .
               else
                   echo "CRITICAL ERROR: Wrong directory $(pwd). Aborting wipe."
                   exit 1
               fi
             else
               git fetch origin main
               git reset --hard origin/main
             fi
                          # Update manifests with the correct image tag
              # Scoped replacement to ensure we only touch the images
              sed -i "s|image: ghcr.io/${{ github.repository }}/api:.*|image: ghcr.io/${{ github.repository }}/api:${IMAGE_TAG}|g" k8s/*.yaml
              sed -i "s|image: ghcr.io/${{ github.repository }}/web:.*|image: ghcr.io/${{ github.repository }}/web:${IMAGE_TAG}|g" k8s/*.yaml
              sed -i "s|image: ghcr.io/${{ github.repository }}/migration:.*|image: ghcr.io/${{ github.repository }}/migration:${IMAGE_TAG}|g" k8s/*.yaml
             
             # Delete old migration/setup jobs and WAIT for them to be fully removed
             # --wait=true ensures the Job is completely gone before we re-apply
             echo "ðŸ—‘ï¸ Deleting old migration jobs..."
             kubectl delete job db-migrate db-seed db-setup -n rejourney --ignore-not-found --wait=true --timeout=60s
             
             # Also delete any leftover pods from previous job runs
             kubectl delete pods -n rejourney -l job-name=db-setup --ignore-not-found --wait=true --timeout=30s || true
             kubectl delete pods -n rejourney -l job-name=db-migrate --ignore-not-found --wait=true --timeout=30s || true
             kubectl delete pods -n rejourney -l job-name=db-seed --ignore-not-found --wait=true --timeout=30s || true
             
             echo "âœ… Old migration jobs cleaned up"

             # Apply all manifests with pruning (removes deleted resources automatically)
             # Uses label selector to only prune resources we manage
             # First apply namespace (not pruned)
             kubectl apply -f k8s/namespace.yaml

             # Auto-install cert-manager if missing (Required for SSL)
             if ! kubectl get namespace cert-manager &> /dev/null; then
               echo "ðŸ”’ cert-manager not found. Installing..."
               kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.16.2/cert-manager.yaml
               
               echo "â³ Waiting for cert-manager to be ready..."
               kubectl wait --for=condition=Available deployment/cert-manager-webhook -n cert-manager --timeout=300s
             fi

             # Apply all other manifests with prune enabled
             # This automatically deletes resources that are no longer in the YAML files
             kubectl apply -f k8s/ \
               --prune \
               -l app.kubernetes.io/part-of=rejourney \
               --prune-allowlist=core/v1/ConfigMap \
               --prune-allowlist=core/v1/Service \
               --prune-allowlist=apps/v1/Deployment \
               --prune-allowlist=apps/v1/StatefulSet \
               --prune-allowlist=networking.k8s.io/v1/Ingress \
               --prune-allowlist=traefik.io/v1alpha1/Middleware \
               --prune-allowlist=batch/v1/CronJob \
               --prune-allowlist=batch/v1/Job
             
             # Wait for migration job to complete before restarting services
             echo "â³ Waiting for db-setup migration job to complete..."
             kubectl wait --for=condition=complete job/db-setup -n rejourney --timeout=300s || {
               echo "âš ï¸ Migration job did not complete in time. Checking status..."
               kubectl describe job db-setup -n rejourney
               kubectl logs job/db-setup -n rejourney --tail=50 || true
               echo "âŒ Migration may have failed - proceeding with deployment but check logs!"
             }
             
             # Restart deployments to force pulling latest images
             kubectl rollout restart deployment api -n rejourney
             kubectl rollout restart deployment web -n rejourney
             kubectl rollout restart deployment ingest-worker -n rejourney
             kubectl rollout restart deployment retention-worker -n rejourney
             kubectl rollout restart deployment alert-worker -n rejourney || echo "Alert worker might be in progress..."
             
             # Clean up old images
             echo "ðŸ§¹ Cleaning up old images..."
             if command -v crictl &> /dev/null; then
               crictl rmi --prune
             elif command -v docker &> /dev/null; then
               docker image prune -af --filter "until=24h"
             fi
             
             # ============================================
             # CLEANUP: Run after every deployment
             # ============================================
             echo "ðŸ§¹ Running post-deploy cleanup..."
             
             # 1. Clean up completed/failed pods
             echo "  â†’ Cleaning completed pods..."
             kubectl delete pods -n rejourney --field-selector=status.phase==Succeeded --ignore-not-found
             kubectl delete pods -n rejourney --field-selector=status.phase==Failed --ignore-not-found
             
             # 2. Clean up old debug pods
             echo "  â†’ Cleaning stale debug pods..."
             kubectl get pods -n rejourney -o json | jq -r '.items[] | select(.metadata.name | startswith("debug-")) | .metadata.name' | xargs -r kubectl delete pod -n rejourney --ignore-not-found || true
             
             # 3. Clean up old completed jobs (keep last 3)
             echo "  â†’ Cleaning old job pods..."
             kubectl get pods -n rejourney -o name | grep -E 'postgres-backup-|db-setup|db-migrate|db-seed' | head -n -3 | xargs -r kubectl delete -n rejourney --ignore-not-found || true
             
             # 4. Clean containerd garbage (exited containers)
             echo "  â†’ Cleaning exited containers..."
             if command -v crictl &> /dev/null; then
               crictl rm $(crictl ps -a -q --state exited) 2>/dev/null || true
             fi
             
             echo "âœ… Cleanup complete!"
